<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Anotador de Truco</title>
    <link rel="icon" type="image/png" href="favicon.png">
    <link rel="manifest" href="/manifest.webmanifest">
    <meta name="theme-color" content="#f8f9fa">

    <!-- iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <link rel="apple-touch-icon" href="/icons/icon-192.png">
    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #333;
            --line-color: #ddd;
            --match-wood: linear-gradient(to bottom, #e3c193, #c5a16f);
            --match-head: radial-gradient(circle at 30% 30%, #ff5f40, #b22222);
            --accent-color: #ff4500;
            --font-main: 'Inter', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            outline: none;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg-color);
            color: var(--text-color);
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            touch-action: manipulation;
            /* Previene el zoom por doble toque */
        }

        /* Header / Reset */
        header {
            height: auto;
            min-height: 60px;
            padding: 0 20px;
            padding-top: env(safe-area-inset-top, 10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--line-color);
            background-color: var(--bg-color);
            z-index: 10;
        }

        #reset-btn {
            background: none;
            border: 1px solid #ccc;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.8rem;
            color: #666;
            cursor: pointer;
            transition: all 0.2s;
        }

        #reset-btn:active {
            background-color: #eee;
            transform: scale(0.95);
        }

        /* Main Layout */
        main {
            flex: 1;
            display: flex;
            position: relative;
        }

        .divider {
            position: absolute;
            left: 50%;
            top: 10%;
            bottom: 30%;
            width: 1px;
            background-color: var(--line-color);
            transform: translateX(-50%);
        }

        .team-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 15px 10px;
            text-align: center;
            cursor: pointer;
        }

        .team-name {
            font-size: 2rem;
            font-weight: 200;
            margin-bottom: 5px;
            color: #222;
        }

        .section-label {
            font-size: 0.65rem;
            letter-spacing: 0.1em;
            color: #999;
            margin-bottom: 5px;
            text-transform: uppercase;
        }

        .score-display {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
            align-items: center;
            justify-content: flex-start;
        }

        /* Controls */
        .controls {
            display: flex;
            height: auto;
            min-height: 120px;
            padding: 10px 20px;
            padding-bottom: calc(40px + env(safe-area-inset-bottom, 10px));
            justify-content: space-around;
            align-items: center;
            border-top: 1px solid var(--line-color);
            background-color: white;
            z-index: 10;
        }

        .btn-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            align-items: center;
        }

        .btn {
            width: 52px;
            height: 52px;
            border: 1px solid #ddd;
            border-radius: 50%;
            background-color: white;
            font-size: 1.5rem;
            color: #444;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.05);
            touch-action: manipulation;
        }

        .btn:active {
            background-color: #f0f0f0;
            transform: scale(0.9);
        }

        .btn-minus {
            font-size: 1.4rem;
            color: #999;
        }

        .btn-plus {
            font-weight: 600;
        }

        .boxes-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            height: 210px;
            /* Space for 3 boxes */
            justify-content: flex-start;
            align-items: center;
        }

        /* Matchstick Logic */
        .match-box {
            width: 60px;
            min-height: 60px;
            position: relative;
            animation: boxAppear 0.3s ease-out;
        }

        @keyframes boxAppear {
            from {
                opacity: 0;
                transform: scale(0.8);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .match {
            position: absolute;
            border-radius: 2px;
            background: var(--match-wood);
            box-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
            animation: matchAppear 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .match::after {
            content: '';
            position: absolute;
            background: var(--match-head);
            border-radius: 50%;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        @keyframes matchAppear {
            from {
                opacity: 0;
                transform: scale(1.5);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes diagonalAppear {
            from {
                opacity: 0;
                transform: translate(-50%, -50%) rotate(45deg) scale(1.5);
            }

            to {
                opacity: 1;
                transform: translate(-50%, -50%) rotate(45deg) scale(1);
            }
        }

        /* Positions */
        /* 1: Left */
        .match-1 {
            left: 5px;
            top: 5px;
            bottom: 5px;
            width: 4px;
        }

        .match-1::after {
            top: -2px;
            left: -1px;
            width: 6px;
            height: 8px;
        }

        /* 2: Top */
        .match-2 {
            left: 5px;
            right: 5px;
            top: 5px;
            height: 4px;
        }

        .match-2::after {
            top: -1px;
            right: -2px;
            width: 8px;
            height: 6px;
        }

        /* 3: Right */
        .match-3 {
            right: 5px;
            top: 5px;
            bottom: 5px;
            width: 4px;
        }

        .match-3::after {
            bottom: -2px;
            left: -1px;
            width: 6px;
            height: 8px;
        }

        /* 4: Bottom */
        .match-4 {
            left: 5px;
            right: 5px;
            bottom: 5px;
            height: 4px;
        }

        .match-4::after {
            bottom: -1px;
            left: -2px;
            width: 8px;
            height: 6px;
        }

        /* 5: Diagonal (Cross) */
        .match-5 {
            left: 50%;
            top: 50%;
            width: 4px;
            height: 75px;
            transform: translate(-50%, -50%) rotate(45deg);
            z-index: 10;
            animation: diagonalAppear 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
        }

        .match-5::after {
            top: -2px;
            left: -1px;
            width: 6px;
            height: 8px;
        }

        .match-box.completed {
            animation: completedGlow 0.5s ease-out;
        }

        @keyframes completedGlow {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
                filter: drop-shadow(0 0 5px var(--accent-color));
            }

            100% {
                transform: scale(1);
            }
        }

        /* Controls logic consolidated above */

        /* Buttons logic consolidated above */

        .btn-minus {
            font-size: 1.2rem;
            color: #999;
            width: 40px;
            height: 40px;
        }

        /* Winner Banner */
        #banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            animation: fadeIn 0.4s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .banner-content {
            background: white;
            padding: 30px 40px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 80%;
        }

        .banner-content h2 {
            font-size: 1.2rem;
            font-weight: 400;
            margin-bottom: 10px;
            color: #666;
        }

        .banner-content p {
            font-size: 1.8rem;
            font-weight: 700;
            color: #222;
        }

        .banner-close {
            margin-top: 20px;
            padding: 8px 20px;
            background: #eee;
            border: none;
            border-radius: 10px;
            font-size: 0.9rem;
            color: #666;
            width: 100%;
        }

        .btn-save-history.saved {
            background-color: #10b981 !important;
            /* Green-500 */
            color: white !important;
            cursor: default;
        }

        /* Score Footer Hint */
        .total-score {
            font-size: 1.8rem;
            font-weight: 700;
            color: #000;
            margin-bottom: 5px;
        }

        /* Menu Screen */
        #menu-screen {
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: var(--bg-color);
            z-index: 1000;
            text-align: center;
            padding: 20px;
        }

        .menu-logo {
            width: 120px;
            height: 120px;
            margin-bottom: 30px;
            position: relative;
            background: white;
            border-radius: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .logo-match {
            width: 8px;
            height: 80px;
            background: var(--match-wood);
            border-radius: 4px;
            position: relative;
            transform: rotate(-15deg);
        }

        .logo-match::after {
            content: '';
            position: absolute;
            top: -4px;
            left: -2px;
            width: 12px;
            height: 16px;
            background: var(--match-head);
            border-radius: 50%;
        }

        #menu-screen h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: #222;
            margin-bottom: 10px;
            letter-spacing: -0.02em;
        }

        #menu-screen p {
            font-size: 1rem;
            color: #888;
            margin-bottom: 50px;
        }

        .btn-start {
            background-color: #222;
            color: white;
            border: none;
            padding: 18px 45px;
            font-size: 1.1rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .btn-start:active {
            transform: scale(0.95);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        #game-screen {
            display: none;
            height: 100vh;
            height: 100dvh;
            flex-direction: column;
        }

        /* Navbar removed duplicate */

        #home-btn {
            background: #eee;
            border: none;
            padding: 6px 15px;
            border-radius: 10px;
            font-size: 0.8rem;
            color: #666;
            font-weight: 500;
            cursor: pointer;
        }

        .btn-menu-group {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .btn-start.secondary {
            background-color: white;
            color: #222;
            border: 2px solid #222;
            box-shadow: none;
        }

        #continue-btn {
            display: none;
        }

        /* New Screens Styles */
        #player-selection-screen,
        #history-screen {
            display: none;
            height: 100vh;
            height: 100dvh;
            width: 100vw;
            flex-direction: column;
            background: white;
            z-index: 1100;
            padding: 20px;
            padding-top: calc(20px + env(safe-area-inset-top, 0px));
            overflow-y: auto;
        }

        .screen-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .screen-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
        }

        .btn-back {
            background: #f0f0f0;
            border: none;
            padding: 8px 15px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .selection-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .player-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f9f9f9;
            border-radius: 15px;
        }

        .player-chip {
            padding: 10px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 10px;
            text-align: center;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .player-chip.selected-n {
            background: #222;
            color: white;
            border-color: #222;
        }

        .player-chip.selected-e {
            background: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .add-player-box {
            display: flex;
            gap: 10px;
        }

        .add-player-box input {
            flex: 1;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-size: 1rem;
        }

        .btn-add {
            background: #222;
            color: white;
            border: none;
            padding: 0 20px;
            border-radius: 12px;
            font-weight: 600;
        }

        /* Login & User UI */
        #user-profile {
            display: none;
            align-items: center;
            gap: 10px;
            margin-top: 20px;
            padding: 10px 15px;
            background: white;
            border-radius: 50px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
        }

        #user-profile img {
            width: 32px;
            height: 32px;
            border-radius: 50%;
        }

        #user-profile span {
            font-size: 0.9rem;
            font-weight: 600;
        }

        .btn-logout {
            background: none;
            border: none;
            color: #ff4500;
            font-size: 0.8rem;
            font-weight: 600;
            cursor: pointer;
            padding-left: 10px;
            border-left: 1px solid #eee;
        }

        .login-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .login-card {
            background: white;
            padding: 30px;
            border-radius: 25px;
            text-align: center;
            width: 100%;
            max-width: 400px;
        }

        .btn-google {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 15px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 12px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            margin-top: 20px;
        }

        .search-player {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            font-size: 0.85rem;
            margin-bottom: 10px;
        }

        .player-chip.disabled {
            opacity: 0.3;
            cursor: not-allowed;
            filter: grayscale(1);
        }

        .history-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .history-item {
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item .date {
            font-size: 0.8rem;
            color: #999;
            margin-bottom: 5px;
        }

        .history-item .teams {
            font-size: 0.95rem;
            font-weight: 600;
        }

        .history-item .score {
            font-size: 1.2rem;
            font-weight: 800;
        }

        .btn-save-history {
            margin-top: 15px;
            padding: 12px 25px;
            background: #111827;
            color: white;
            border: none;
            border-radius: 50px;
            font-weight: 600;
            display: none;
        }
    </style>
</head>

<div id="menu-screen">
    <div class="menu-logo">
        <div class="logo-match"></div>
    </div>
    <h1>Anotador de truco</h1>
    <p>Envido y Truco</p>
    <div class="btn-menu-group">
        <button class="btn-start" onclick="checkAuthForHistory()">Iniciar Partido (Con historial)</button>
        <button class="btn-start secondary" onclick="newGame(false)">Partida R√°pida</button>
        <button class="btn-start secondary" id="continue-btn" onclick="startGame(true)">Continuar Partido</button>
        <button class="btn-start" style="background:#f0f0f0; color:#222; box-shadow:none; margin-top:10px"
            onclick="openHistory()">Historial</button>
    </div>

    <div id="user-profile">
        <img id="user-avatar" src="" alt="avatar">
        <span id="user-name"></span>
        <button class="btn-logout" onclick="signOut()">Salir</button>
    </div>
</div>

<div id="login-overlay" class="login-overlay">
    <div class="login-card">
        <h3>Acceso Requerido</h3>
        <p style="color: #666; margin-top: 10px">Inici√° sesi√≥n con Google para registrar partidos y mantener el
            historial.</p>
        <button class="btn-google" onclick="signInWithGoogle()">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
            Continuar con Google
        </button>
        <button class="btn-back" style="margin-top: 20px; width: 100%" onclick="closeLogin()">Quiz√°s luego</button>
    </div>
</div>

<div id="player-selection-screen">
    <div class="screen-header">
        <h2>Seleccionar Jugadores</h2>
        <button class="btn-back" onclick="showMenu()">Cancelar</button>
    </div>
    <div class="selection-container">
        <div>
            <label class="section-label">Sede (Opcional)</label>
            <input type="text" id="match-location" placeholder="Lugar (Ej: El quincho, Club...)" class="search-player"
                style="font-size: 1rem; padding: 12px">

            <label class="section-label" style="margin-top: 15px">Crear Jugador</label>
            <div class="add-player-box">
                <input type="text" id="new-player-name" placeholder="Nombre...">
                <button class="btn-add" onclick="createNewPlayer()">+</button>
            </div>
        </div>
        <div>
            <label class="section-label">N (M√°x 3)</label>
            <input type="text" id="search-n" placeholder="Buscar jugador..." class="search-player"
                oninput="renderPlayerSelection()">
            <div id="list-n" class="player-list"></div>
        </div>
        <div>
            <label class="section-label">E (M√°x 3)</label>
            <input type="text" id="search-e" placeholder="Buscar jugador..." class="search-player"
                oninput="renderPlayerSelection()">
            <div id="list-e" class="player-list"></div>
        </div>
        <button class="btn-start" id="start-match-btn" onclick="startHistoryMatch()">Comenzar Partido</button>
    </div>
</div>

<div id="history-screen">
    <div class="screen-header">
        <h2>Historial de Partidos</h2>
        <button class="btn-back" onclick="showMenu()">Volver</button>
    </div>
    <div id="history-container" class="history-list">
        <!-- Partidos se cargan ac√° -->
    </div>
</div>

<div id="game-screen">
    <header>
        <button id="home-btn" onclick="showMenu()">Menu principal</button>
        <button id="reset-btn" onclick="reset()">Reset</button>
    </header>

    <main>
        <div class="divider"></div>

        <!-- Team N -->
        <div class="team-panel">
            <div class="team-name">N</div>

            <div class="score-display" onclick="addPoint('N')">
                <div class="section">
                    <div class="section-label">Malas</div>
                    <div id="malas-N" class="boxes-container"></div>
                </div>

                <div class="section">
                    <div class="section-label">Buenas</div>
                    <div id="buenas-N" class="boxes-container"></div>
                </div>
            </div>

            <div class="total-score" id="total-N">0</div>
        </div>

        <!-- Team E -->
        <div class="team-panel">
            <div class="team-name">E</div>

            <div class="score-display" onclick="addPoint('E')">
                <div class="section">
                    <div class="section-label">Malas</div>
                    <div id="malas-E" class="boxes-container"></div>
                </div>

                <div class="section">
                    <div class="section-label">Buenas</div>
                    <div id="buenas-E" class="boxes-container"></div>
                </div>
            </div>

            <div class="total-score" id="total-E">0</div>
        </div>
    </main>

    <div class="controls">
        <div class="btn-group">
            <button class="btn btn-minus" onclick="subPoint('N', event)">-</button>
            <button class="btn btn-plus" onclick="addPoint('N', event)">+</button>
        </div>
        <div class="btn-group">
            <button class="btn btn-minus" onclick="subPoint('E', event)">-</button>
            <button class="btn btn-plus" onclick="addPoint('E', event)">+</button>
        </div>
    </div>
</div>

<div id="banner">
    <div class="banner-content">
        <h2>Partida finalizada</h2>
        <p id="winner-text"></p>
        <button id="save-match-btn" class="btn-save-history" onclick="saveMatchToSupabase()" style="width: 100%">Guardar
            en
            Historial</button>
        <button class="banner-close" onclick="closeWinnerBanner()">Volver / Corregir</button>
        <button class="banner-close" onclick="goToMainMenu()"
            style="background: transparent; color: #888; border: 1px solid #eee; margin-top: 10px">Volver al Menu
            Principal</button>
    </div>
</div>

<script>
    const supabaseUrl = 'https://toqnuoeqsyfexllyzpkg.supabase.co';
    const supabaseKey = 'sb_publishable_THvcwWOsyfbXrY5ZXthyMg_bbB0CsDH';
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    let scores = { N: 0, E: 0 };
    let gameOver = false;
    let isHistoryMatch = false;
    let matchLocation = "";
    let selectedN = [];
    let selectedE = [];
    let allPlayers = [];
    let currentUser = null;

    // Init
    document.addEventListener('DOMContentLoaded', async () => {
        // Escuchar cambios de sesi√≥n
        supabaseClient.auth.onAuthStateChange((event, session) => {
            currentUser = session?.user || null;
            updateUserUI();
        });

        // Verificar sesi√≥n inicial
        const { data: { session } } = await supabaseClient.auth.getSession();
        currentUser = session?.user || null;
        updateUserUI();

        const saved = localStorage.getItem('truco-scores');
        const inGame = localStorage.getItem('truco-playing');
        const savedMatchState = localStorage.getItem('truco-match-state');

        if (saved) {
            scores = JSON.parse(saved);
            if (scores.N >= 30 || scores.E >= 30) {
                gameOver = true;
            }
        }

        if (savedMatchState) {
            const state = JSON.parse(savedMatchState);
            isHistoryMatch = state.isHistoryMatch;
            selectedN = state.selectedN || [];
            selectedE = state.selectedE || [];
            matchLocation = state.matchLocation || "";
            document.getElementById('match-location').value = matchLocation;
        }

        if (inGame === 'true') {
            startGame(true);
        } else {
            showMenu();
        }

        render();
        loadAllPlayers();
    });

    function updateUserUI() {
        const profile = document.getElementById('user-profile');
        if (currentUser) {
            document.getElementById('user-name').innerText = currentUser.user_metadata.full_name.split(' ')[0];
            document.getElementById('user-avatar').src = currentUser.user_metadata.avatar_url;
            profile.style.display = 'flex';
        } else {
            profile.style.display = 'none';
        }
    }

    async function signInWithGoogle() {
        const { error } = await supabaseClient.auth.signInWithOAuth({
            provider: 'google',
            options: {
                redirectTo: window.location.href.split('#')[0].split('?')[0]
            }
        });
        if (error) alert("Error al iniciar sesi√≥n: " + error.message);
    }

    async function signOut() {
        await supabaseClient.auth.signOut();
    }

    function checkAuthForHistory() {
        if (!currentUser) {
            document.getElementById('login-overlay').style.display = 'flex';
        } else {
            openPlayerSelection();
        }
    }
    window.checkAuthForHistory = checkAuthForHistory;

    function closeLogin() {
        document.getElementById('login-overlay').style.display = 'none';
    }
    window.closeLogin = closeLogin;

    async function loadAllPlayers() {
        const { data, error } = await supabaseClient.from('jugadores').select('*').order('nombre');
        if (!error) {
            allPlayers = data;
            renderPlayerSelection();
        }
    }

    function renderPlayerSelection() {
        const listN = document.getElementById('list-n');
        const listE = document.getElementById('list-e');

        const normalize = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();

        const searchN = normalize(document.getElementById('search-n').value);
        const searchE = normalize(document.getElementById('search-e').value);

        listN.innerHTML = '';
        listE.innerHTML = '';

        allPlayers.forEach(p => {
            const pName = normalize(p.nombre);
            if (pName.includes(searchN)) {
                const chipN = createPlayerChip(p, 'N');
                listN.appendChild(chipN);
            }
            if (pName.includes(searchE)) {
                const chipE = createPlayerChip(p, 'E');
                listE.appendChild(chipE);
            }
        });

        validateMatchStart();
    }

    function validateMatchStart() {
        const btn = document.getElementById('start-match-btn');
        // Regla: Equipos deben ser de igual tama√±o (1v1, 2v2, 3v3) y no estar vac√≠os
        const isValid = selectedN.length > 0 && selectedN.length === selectedE.length;
        btn.disabled = !isValid;
        btn.style.opacity = isValid ? '1' : '0.5';
    }

    function createPlayerChip(player, team) {
        const div = document.createElement('div');
        div.className = 'player-chip';
        const isSelectedN = selectedN.includes(player.nombre);
        const isSelectedE = selectedE.includes(player.nombre);

        if (team === 'N' && isSelectedN) div.classList.add('selected-n');
        if (team === 'E' && isSelectedE) div.classList.add('selected-e');

        // Disable chips that would exceed the 3 player limit or are already on the other team
        const otherTeam = team === 'N' ? selectedE : selectedN;
        const currentTeam = team === 'N' ? selectedN : selectedE;

        div.innerText = player.nombre;
        div.onclick = () => togglePlayer(player.nombre, team);
        return div;
    }

    function togglePlayer(name, team) {
        if (team === 'N') {
            if (selectedN.includes(name)) {
                selectedN = selectedN.filter(n => n !== name);
            } else {
                if (selectedN.length >= 3) return; // M√°ximo 3
                selectedN.push(name);
                // Exclusi√≥n mutua: si estaba en el otro equipo, lo sacamos
                selectedE = selectedE.filter(n => n !== name);
            }
        } else {
            if (selectedE.includes(name)) {
                selectedE = selectedE.filter(n => n !== name);
            } else {
                if (selectedE.length >= 3) return; // M√°ximo 3
                selectedE.push(name);
                // Exclusi√≥n mutua
                selectedN = selectedN.filter(n => n !== name);
            }
        }
        renderPlayerSelection();
    }

    async function createNewPlayer() {
        const name = document.getElementById('new-player-name').value.trim();
        if (!name) return;

        // Intentamos obtener el email del creador si est√° logueado
        const { data: { user } } = await supabaseClient.auth.getUser();
        const userEmail = user ? user.email : null;

        const { error } = await supabaseClient.from('jugadores').insert([{
            nombre: name,
            creado_por: userEmail
        }]);
        if (error) {
            alert('Error al crear jugador (posiblemente ya existe)');
        } else {
            document.getElementById('new-player-name').value = '';
            loadAllPlayers();
        }
    }

    function goToMainMenu() {
        scores = { N: 0, E: 0 };
        gameOver = false;
        localStorage.removeItem('truco-scores');
        localStorage.removeItem('truco-playing');
        localStorage.removeItem('truco-match-state');
        closeWinnerBanner();
        showMenu();
    }

    function openPlayerSelection() {
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('player-selection-screen').style.display = 'flex';
    }

    function startHistoryMatch() {
        if (selectedN.length === 0 || selectedE.length === 0) {
            alert('Seleccion√° al menos un jugador por equipo.');
            return;
        }
        if (selectedN.length !== selectedE.length) {
            alert('Los equipos deben tener la misma cantidad de jugadores (Ej: 2 vs 2).');
            return;
        }
        matchLocation = document.getElementById('match-location').value.trim();
        isHistoryMatch = true;
        newGame(true);
    }

    async function openHistory() {
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('history-screen').style.display = 'flex';

        const { data, error } = await supabaseClient.from('partidos').select('*').order('fecha', { ascending: false }).limit(20);
        const container = document.getElementById('history-container');
        container.innerHTML = '';

        if (!error && data) {
            data.forEach(m => {
                const date = new Date(m.fecha).toLocaleDateString();
                const place = m.lugar ? `üìç ${m.lugar}` : '';
                const item = document.createElement('div');
                item.className = 'history-item';
                item.innerHTML = `
                    <div style="flex:1">
                        <div class="date">${date} ${place}</div>
                        <div class="teams">${m.equipo_n_jugadores.join(', ')} vs ${m.equipo_e_jugadores.join(', ')}</div>
                    </div>
                    <div class="score">${m.puntos_n} - ${m.puntos_e}</div>
                `;
                container.appendChild(item);
            });
        }
    }

    function newGame(isH) {
        if (scores.N > 0 || scores.E > 0) {
            if (!confirm('Esto reiniciar√° el marcador. ¬øContinuar?')) return;
        }
        isHistoryMatch = isH || false;

        // Clear selection if it's a quick match
        if (!isHistoryMatch) {
            selectedN = [];
            selectedE = [];
            renderPlayerSelection();
        }

        scores = { N: 0, E: 0 };
        gameOver = false;
        document.getElementById('banner').style.display = 'none';
        document.getElementById('player-selection-screen').style.display = 'none';
        save();
        render();
        startGame();
    }
    window.newGame = newGame;

    function startGame(skipSave = false) {
        document.getElementById('menu-screen').style.display = 'none';
        document.getElementById('game-screen').style.display = 'flex';
        if (!skipSave) {
            localStorage.setItem('truco-playing', 'true');
        }
    }
    window.startGame = startGame;

    function showMenu() {
        document.getElementById('menu-screen').style.display = 'flex';
        document.getElementById('game-screen').style.display = 'none';
        document.getElementById('player-selection-screen').style.display = 'none';
        document.getElementById('history-screen').style.display = 'none';
        localStorage.setItem('truco-playing', 'false');

        // Show continue button if there's progress
        const continueBtn = document.getElementById('continue-btn');
        if (scores.N > 0 || scores.E > 0) {
            continueBtn.style.display = 'block';
        } else {
            continueBtn.style.display = 'none';
        }
    }
    window.showMenu = showMenu;

    function save() {
        localStorage.setItem('truco-scores', JSON.stringify(scores));
        localStorage.setItem('truco-match-state', JSON.stringify({
            isHistoryMatch, selectedN, selectedE, matchLocation
        }));
    }

    function addPoint(team, event) {
        if (event) event.stopPropagation();
        if (gameOver) return;

        if (scores[team] < 30) {
            scores[team]++;
            save();
            render();

            if (scores[team] === 30) {
                showWinner(team);
            }
        }
    }

    function subPoint(team, event) {
        if (event) event.stopPropagation();

        if (scores[team] > 0) {
            scores[team]--;
            gameOver = false; // Allow adding again if score drops
            save();
            render();
        }
    }

    function reset() {
        if (confirm('¬øReiniciar la partida?')) {
            scores = { N: 0, E: 0 };
            gameOver = false;
            document.getElementById('banner').style.display = 'none';
            save();
            render();
        }
    }
    window.reset = reset;

    function showWinner(team) {
        gameOver = true;
        document.getElementById('winner-text').innerText = `Gan√≥ ${team === 'N' ? 'EQUIPO N' : 'EQUIPO E'}`;
        document.getElementById('banner').style.display = 'flex';

        const saveBtn = document.getElementById('save-match-btn');
        // Resetear estado del bot√≥n para cada nueva victoria
        saveBtn.disabled = false;
        saveBtn.innerText = "Guardar en Historial";
        saveBtn.classList.remove('saved');

        if (isHistoryMatch) {
            saveBtn.style.display = 'block';
        } else {
            saveBtn.style.display = 'none';
        }
    }

    async function saveMatchToSupabase() {
        const btn = document.getElementById('save-match-btn');
        if (btn.disabled) return;

        btn.disabled = true;
        btn.innerText = "Guardando...";

        const winner = scores.N >= 30 ? 'N' : 'E';

        // Forzamos obtener el usuario de la sesi√≥n actual antes de guardar
        const { data: { user } } = await supabaseClient.auth.getUser();
        const userEmail = user ? user.email : null;

        const { error } = await supabaseClient.from('partidos').insert([{
            equipo_n_jugadores: selectedN,
            equipo_e_jugadores: selectedE,
            puntos_n: scores.N,
            puntos_e: scores.E,
            ganador: winner,
            lugar: matchLocation,
            creado_por: userEmail
        }]);

        if (error) {
            console.error("Error al guardar:", error);
            btn.disabled = false;
            btn.innerText = "Error al Guardar";
            setTimeout(() => { btn.innerText = "Guardar en Historial"; }, 3000);
        } else {
            btn.innerText = "Partida Guardada";
            btn.classList.add('saved');

            // Actualizar estad√≠sticas usando RPC
            const winners = winner === 'N' ? selectedN : selectedE;
            const losers = winner === 'N' ? selectedE : selectedN;

            await supabaseClient.rpc('actualizar_estadisticas_partido', {
                p_ganadores: winners,
                p_perdedores: losers
            });

            // Notificar por mail (ya no mostramos alert)
            notificarPartido(winner);
        }
    }

    async function notificarPartido(winner) {
        console.log("Iniciando proceso de notificaci√≥n...");

        // 1. Recolectar emails de los jugadores involucrados
        const todosLosJugadores = [...selectedN, ...selectedE];
        console.log("Jugadores en este partido:", todosLosJugadores);

        const emailsParaNotificar = allPlayers
            .filter(p => todosLosJugadores.includes(p.nombre) && p.email)
            .map(p => p.email);

        if (emailsParaNotificar.length === 0) {
            console.warn("‚ö†Ô∏è Abortando mail: Ninguno de los jugadores seleccionados tiene un email registrado en la tabla 'jugadores'.");
            return;
        }

        console.log("üìß Emails encontrados para notificar:", emailsParaNotificar);

        // 2. Preparar el contenido del mail
        const subject = `Resultado Truco: ${selectedN.join(', ')} vs ${selectedE.join(', ')}`;
        const html = `
            <div style="font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; padding: 20px; color: #333; max-width: 600px; margin: auto; border: 1px solid #eee; border-radius: 20px; background-color: #ffffff;">
                <h1 style="color: #111827; text-align: center; font-size: 24px; margin-bottom: 5px;">¬°Partido Registrado!</h1>
                <p style="text-align: center; color: #6b7280; font-size: 16px; margin-bottom: 30px;">Se ha guardado un nuevo partido en el historial.</p>
                
                <div style="background-color: #f9fafb; padding: 30px; border-radius: 20px; margin-bottom: 25px;">
                    <p style="margin: 0 0 25px 0; font-size: 14px; color: #9ca3af; text-align: center; font-weight: 500;">
                        üìç ${matchLocation || 'Sede no especificada'}
                    </p>
                    
                    <table width="100%" cellpadding="0" cellspacing="0" border="0">
                        <tr>
                            <td width="42%" align="center" valign="top">
                                <p style="margin: 0; font-size: 12px; color: #9ca3af; font-weight: bold; letter-spacing: 1px;">EQUIPO N</p>
                                <h2 style="margin: 10px 0; font-size: 48px; color: #111827; line-height: 1;">${scores.N}</h2>
                                <p style="margin: 5px 0 0 0; font-size: 14px; color: #4b5563; line-height: 1.4;">${selectedN.join('<br>')}</p>
                            </td>
                            <td width="16%" align="center" valign="middle">
                                <div style="font-size: 14px; font-weight: bold; color: #d1d5db; padding-top: 20px;">VS</div>
                            </td>
                            <td width="42%" align="center" valign="top">
                                <p style="margin: 0; font-size: 12px; color: #9ca3af; font-weight: bold; letter-spacing: 1px;">EQUIPO E</p>
                                <h2 style="margin: 10px 0; font-size: 48px; color: #111827; line-height: 1;">${scores.E}</h2>
                                <p style="margin: 5px 0 0 0; font-size: 14px; color: #4b5563; line-height: 1.4;">${selectedE.join('<br>')}</p>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <div style="text-align: center; padding: 15px; background-color: #ecfdf5; border-radius: 12px; border: 1px solid #d1fae5;">
                    <p style="margin: 0; font-size: 18px; color: #065f46; font-weight: 600;">
                        üèÜ Ganador: ${winner === 'N' ? 'EQUIPO N' : 'EQUIPO E'}
                    </p>
                </div>
            </div>
        `;

        // 3. Llamar a la Edge Function
        console.log("üöÄ Llamando a la Edge Function 'brevo-email'...");
        const { data, error } = await supabaseClient.functions.invoke('brevo-email', {
            body: {
                to: emailsParaNotificar,
                subject: subject,
                html: html
            }
        });

        if (error) {
            console.error("‚ùå Error de Supabase al invocar la funci√≥n:", error);
        } else {
            console.log("‚úÖ Respuesta de la Edge Function:", data);
        }
    }

    function closeWinnerBanner() {
        document.getElementById('banner').style.display = 'none';
        // If it was over, but they closed it, allow correcting the score
    }

    function render() {
        renderTeam('N');
        renderTeam('E');
    }

    function renderTeam(team) {
        const total = scores[team];
        document.getElementById(`total-${team}`).innerText = total;

        const malas = Math.min(total, 15);
        const buenas = Math.max(0, total - 15);

        renderSection(`malas-${team}`, malas);
        renderSection(`buenas-${team}`, buenas);
    }

    function renderSection(containerId, count) {
        const container = document.getElementById(containerId);

        // Current number of boxes shown
        const boxesNeeded = Math.ceil(count / 5);

        // Clear or update efficiently
        // For simplicity and to handle animations on new matches, we'll reconcile

        const currentBoxes = container.querySelectorAll('.match-box');

        // If we need fewer boxes than we have, just re-render (usually on sub)
        if (boxesNeeded < currentBoxes.length) {
            container.innerHTML = '';
        }

        for (let i = 0; i < boxesNeeded; i++) {
            let box = container.children[i];
            if (!box) {
                box = document.createElement('div');
                box.className = 'match-box';
                container.appendChild(box);
            }

            // Points in this box
            const pointsInBox = Math.min(5, count - (i * 5));

            // Update matches inside box
            const currentMatches = box.querySelectorAll('.match').length;

            if (pointsInBox < currentMatches) {
                box.innerHTML = ''; // Reset if points decreased
            }

            for (let p = box.querySelectorAll('.match').length + 1; p <= pointsInBox; p++) {
                const match = document.createElement('div');
                match.className = `match match-${p}`;
                box.appendChild(match);

                if (p === 5) {
                    box.classList.add('completed');
                }
            }

            if (pointsInBox < 5) {
                box.classList.remove('completed');
            }
        }

        // Remove extra boxes if count decreased
        while (container.children.length > boxesNeeded) {
            container.removeChild(container.lastChild);
        }
    }
</script>

<script>
    if ("serviceWorker" in navigator) {
        window.addEventListener("load", () => {
            navigator.serviceWorker.register("/sw.js");
        });
    }
</script>
</body>

</html>